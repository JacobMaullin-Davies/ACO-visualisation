<!DOCTYPE html>
{% include 'navbar.html' %}
<html lang="en" dir="ltr">
  <head>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" /> <!-- original: http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css -->
<style>
    div.ex1 {
      width: 80%;
      margin: auto;
      border: 3px solid #73AD21;
    }
    div.ex2 {
      padding-top: 10px;
      margin: auto;
      border: 3px solid #73AD21;
    }
    html, body, #container, #map {
      padding: 0;
      margin: 0;
    }
    html, body, #map, #container {
    height: 600px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
    }

    input:checked + .slider {
      background-color: #2196F3;
    }

    input:focus + .slider {
      box-shadow: 0 0 1px #2196F3;
    }

    input:checked + .slider:before {
      -webkit-transform: translateX(26px);
      -ms-transform: translateX(26px);
      transform: translateX(26px);
    }

    .select_area {
      margin: 0 auto;
      display: block;
      text-align: center;
    }
    #button1, #button2, #button3{
      width: 200px;
      height: 40px;
      }


    </style>
  <meta charset="utf-8">
  <title></title>
  </head>
  <p></p>
  <body>
    <div class = "select_area">
      <button id = "button1" onclick = "reset()">Reset</button>
      <button id = "button2" onclick = "run_steps_2()">Run Vis</button>
      <select name="algorithm" id="algo" onchange="toggle()">
        <option value="ACO-B">ACO-Basic</option>
        <option value="ACO-B">ACO-Leaders</option>
        <option value="ACO-B">ACO-Astar-Local</option>
        <option value="DIJ">Dijkstra</option>
        <option value="DFS">Depth-first-search</option>
      </select>
    </div>
    <br>
    <div class = "select_area">
      <label for="quantity">Pheromone evaporate</label>
      <input type="number" id="quantity" name="quantity" value="0.8" step="0.05" min="0.05" max="1">
      <label for="quantity">Ant number</label>
      <input type="number" id="ant_q" name="ant_q" value="50" step="2" min="2" max="100">
      <label>Speed</label>
      <input id='speed_id' name='speed' type="range" value="15" min="1" max="20" onchange="speed_set()">
      <br>
          <br>
      <div id="cont">
        <label class="switch">
          <input type="checkbox">
          <span class="slider" onclick="toggle_ant_paths()"></span>
        </label>
      </div>
    </div>







    <!-- <button onclick="start_vis()">Run</button><br></br> -->

    <div class="ex2">
      <div class="ex1">
            <div id="map"></div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    <canvas id="myChart" style="width:100%;max-width:600px"></canvas>

  </body>
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
  <script src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>
  <script type="text/javascript">

    var xValues = [50,60,70,80,90,100,110,120,130,140,150];
    var yValues = [7,8,8,9,9,9,10,11,14,14,15];

    new Chart("myChart", {
    type: "line",
    data: {
      labels: xValues,
      datasets: [{
        fill: false,
        lineTension: 0,
        backgroundColor: "rgba(0,0,255,1.0)",
        borderColor: "rgba(0,0,255,0.1)",
        data: yValues
      }]
    },
    options: {
      legend: {display: false},
      scales: {
        yAxes: [{ticks: {min: 6, max:16}}],
      }
    }
    });


    var tileLayer = new L.TileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',{
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
    });

    var arr = [[]];
    var bbox = {{bbox}};
    var isPaused = false;
    var final = false;
    var graph_ev = [];
    var toggle_antPath_num = false;
    var speed = document.getElementById('speed_id').value

    var colors = [];

    //var c = ['purple', 'green', 'orange']

    var polygonLines = L.markerClusterGroup({interactive: false})
    var cirLines = L.layerGroup()


    var map = new L.Map('map', {
      'center': [51.75350586724182, -1.80169538827613],
      'zoom': 10,
      'layers': [tileLayer],
      maxZoom: 19,
      minZoom: 2,
      max_bounds : 'True',
      selectArea: true ,
    });

    if(bbox.length != 0){
        map.fitBounds(bbox)
        var newMarker = new L.marker({{origin}}).addTo(map)
        var newMarker = new L.marker({{dest}}).addTo(map)

        var bounds = [[bbox[1], bbox[0]], [bbox[3], bbox[2]]];

        // create an orange rectangle
        L.rectangle(bounds, {color: "#ff7800", weight: 1, clickable : false, hover: false}).addTo(map);
    }


  function reset(){
    isPaused = false;
    final = false;
    try{
      polygonLines.clearLayers()
      polygonLines.setStyle({ color: 'blue'  });
    }catch{
      console.log("No lines to clear")
    }
    try{
      cirLines.clearLayers()
    }catch{
      console.log("No lines to clear")
    }


    $.ajax({
            url: "/reset_path",
            type: 'get',
        })
    //location.reload()
  }

  function speed_set(){
    speed = document.getElementById('speed_id').value
    console.log(speed);
  }

  function toggle(){
    var cont = document.getElementById('cont');
    var e_a = document.getElementById("algo");
    var algorithm = e_a.options[e_a.selectedIndex].text;
    console.log(algorithm)
    if (algorithm == 'ACO-Basic'){
        cont.style.display = 'block';
    }else if (algorithm == 'ACO-Leaders') {
      cont.style.display = 'block';
    }else if (algorithm == 'ACO-Astar-Local'){
      cont.style.display = 'block';
    }else{
      cont.style.display = 'none';
    }
  }


  function toggle_ant_paths(){
    toggle_antPath_num = !toggle_antPath_num
    console.log(toggle_antPath_num)
  }

  function path_finish(){
    $.ajax({
            url: "/path_finish",
            type: 'get',
        })
    isPaused = false;
  }



  function delay(time) {
    return new Promise(resolve => setTimeout(resolve, time));
  }

  function evaporate(){
    for (var i = 0; i < (graph_ev.length/1.7); i++) {
      polygonLines.removeLayer(graph_ev[i])
    }

  }

  async function show_points(){
      for (var i = 0; i < arr.length; i++) {
        await delay(1);
        var new_sarr = arr[i];
        var cir = L.circle(new_sarr, 2)
        cirLines.addLayer(cir)
        cirLines.addTo(map)
      }
      path_finish()
  }


    async function run_steps(resp) {
      if (arr.length > 0){
        if(resp.runType == false){
          if(resp.path_num){
            console.log(arr.length)
            for (var i = 0; i < arr.length; i++) {
              var break_arr = arr[i]
              console.log(i)
              drawDottedLine(break_arr, colors[i])
            }
            if(!final){
              console.log("called")
              evaporate()
            }
          }else{
              console.log(speed);
            for (var i = 0; i < arr.length; i+=19) {
              await delay(1);
              var new_arr = arr.slice(i, i+20);
              drawDottedLine(new_arr, colors[0])
            }
          }
          if(!final){
            evaporate()
          }
          path_finish()
        }else{
          show_points()
      }

    }
  }

    function drawDottedLine(points, cc){
      if (!final){
        var polyline = new L.polyline(points)
        graph_ev.push(polyline)
        polyline.setStyle({color: cc, opacity: 0.1});
        polyline.addTo(polygonLines);
      }else{
        var polyline = new L.polyline(points)
        graph_ev.push(polyline)
        polyline.setStyle({color: 'red', opacity: 0.9});
        polyline.addTo(polygonLines);
      }
      polygonLines.addTo(map) //add to map above
    }

    function run_steps_2(){
      if (bbox.length != 0){
        var e_a = document.getElementById("algo");
        var algorithm = e_a.options[e_a.selectedIndex].text;
        var e_pe = document.getElementById("quantity").value;
        var ant_num  = document.getElementById("ant_q").value;

        while (colors.length < Math.round(ant_num*0.1)) {
            do {
                var color = Math.floor((Math.random()*1000000)+1);
            } while (colors.indexOf(color) >= 0);
            colors.push("#" + ("000000" + color.toString(16)).slice(-6));
        }
        console.log(colors);

        $.ajax({
                url: "/path_start",
                type: 'get',
                data: {'a_type': algorithm,
                       'evap_val': e_pe,
                       'ant_num': ant_num,
                       'path_toggle': toggle_antPath_num
                     }
            })
        var t = window.setInterval(function() {
          if(!isPaused) {
            fetch('../api_pointUpdate')
            .then(response => response.json())
            .then(resp => {
            if (resp.done){
                 console.log("FIN")
                 window.clearInterval(t);
                 final = true;
                 arr = resp.array;
                 run_steps(resp);
            }else{
              if (resp.running){
                if(resp.array.length == 0){
                  $.ajax({
                          url: "/path_finish",
                          type: 'get',
                      })
                  isPaused = false;
                }else{
                  arr = resp.array;
                  isPaused = true;
                  run_steps(resp)
                }
              }
            }
          });
        }
      }, 300);
    }
  }






    // function run_steps_2(){
    //     $.ajax({
    //             url: "../api_pointUpdate",
    //             type: 'get',
    //         })








</script>
</html>
