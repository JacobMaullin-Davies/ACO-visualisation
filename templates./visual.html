<!DOCTYPE html>
{% include 'navbar.html' %}
<html lang="en" dir="ltr">
  <head>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" /> <!-- original: http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css -->
<style>
    div.ex1 {
      width: 80%;
      margin: auto;
      border: 3px solid #73AD21;
    }
    div.ex2 {
      padding-top: 10px;
      margin: auto;
      border: 3px solid #73AD21;
    }
    html, body, #container, #map {
      padding: 0;
      margin: 0;
    }
    html, body, #map, #container {
    height: 600px;
    }

    </style>
  <meta charset="utf-8">
  <title></title>
  </head>
  <p></p>
  <body>
    <button onclick="run_steps()">Run</button><br></br>
    <button onclick="run_steps_2()">Run2</button><br></br>

    <!-- <button onclick="start_vis()">Run</button><br></br> -->

    <div class="ex2">
      <div class="ex1">
            <div id="map"></div>
      </div>
    </div>

  </body>
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
  <script src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>
  <script type="text/javascript">




    var tileLayer = new L.TileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',{
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
    });

    var arr = [[]]
    var bbox = {{bbox}}
    var isPaused = false;
    var final = false


    var map = new L.Map('map', {
      'center': [28.644800, 77.216721],
      'zoom': 12,
      'layers': [tileLayer],
      maxZoom: 19,
      minZoom: 2,
      max_bounds : 'True',
      selectArea: true ,
    });

    map.fitBounds(bbox)

    var newMarker = new L.marker({{origin}}).addTo(map)
    var newMarker = new L.marker({{dest}}).addTo(map)

    var bounds = [[bbox[1], bbox[0]], [bbox[3], bbox[2]]];

    // create an orange rectangle
    L.rectangle(bounds, {color: "#ff7800", weight: 1}).addTo(map);



    function delay(time) {
      return new Promise(resolve => setTimeout(resolve, time));
    }

    function polystyle(feature) {
    return {
        fillColor: 'red',
        weight: 2,
        opacity: 1,
        color: 'red',  //Outline color
        fillOpacity: 0.7
    };
  }



    async function run_steps() {
      for (var i = 0; i < arr.length; i++) {

        await delay(1);

        var new_arr = arr.slice(i, i+2);

        drawDottedLine(new_arr)
      }

      //drawDottedLine(arr)
      $.ajax({
              url: "/path_finish",
              type: 'get',
          })
      isPaused = false;
    }

    function drawDottedLine(points){
      if (!final){
        var polyline = new L.polyline(points).addTo(map);
      }else{
        //console.log("RUN")
        var polyline = new L.polyline(points)
        polyline.setStyle({color: 'red'});
        polyline.addTo(map);
      }

    }



    function run_steps_2(){


      $.ajax({
              url: "/path_start",
              type: 'get',
          })
      var t = window.setInterval(function() {
        if(!isPaused) {
          fetch('../api_pointUpdate')
          .then(response => response.json())
          .then(resp => {
          //console.log(resp.array);
          if (resp.done){
               console.log("FIN")
               window.clearInterval(t);
               final = true;
               run_steps();

          }else{
            if (resp.running){
              arr = resp.array;
              isPaused = true;
              run_steps()
            }
        }
      });
    }
  }, 500);}





    // function run_steps_2(){
    //     $.ajax({
    //             url: "../api_pointUpdate",
    //             type: 'get',
    //         })








</script>
</html>
